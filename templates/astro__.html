<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>占星命盤文字資料</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Base body styling with a modern, saturated multi-color gradient background */
        body {
            font-family: 'Inter', 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 0.5rem;
            box-sizing: border-box;
            overflow-y: auto;
            transition: background 1s ease-in-out;
        }

        /* 輸出容器 */
        #resultOutput {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* 「大餐盤」(單一星盤) 的樣式 */
        .chart-wrapper {
            border: 1px solid #dcdfe6;
            border-radius: 12px;
            background-color: #fff;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .chart-main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        /* Specific header colors */
        .single-chart-header-main { background: linear-gradient(to right, #2084ff, #dfecff); }
        .comparison-chart-header-main { background: linear-gradient(to right, #8B008B, #ffc0cb); }
        .composite-chart-header-main { background: linear-gradient(to right, #fde047, #fef9c3); }
        .transit-chart-header-main { background: linear-gradient(to right, #00db6d, #ceffe6); }


        .chart-main-header h2 {
            margin: 0;
            font-size: 1.5em;
            flex-grow: 1;
            margin-right: 20px;
        }
        
        .sub-sections-container, .summary-section-container {
            padding: 1rem;
            display: flex;
            flex-direction: column; 
            gap: 1rem;
        }

        /* 動態背景的動畫 */
        @keyframes move-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 個人星盤背景 */
        .bg-single {
            background: radial-gradient(circle at top left, #00008B, transparent 40%), radial-gradient(circle at top right, #ffd13b, transparent 40%), radial-gradient(circle at bottom left, #009d95, transparent 40%), radial-gradient(circle at bottom right, #2F4F4F, transparent 40%);
            background-size: 400% 400%;
            animation: move-bg 20s ease infinite;
        }

        /* 雙人合盤背景 */
        .bg-synastry {
            background: radial-gradient(circle at top left, #FF4500, transparent 40%), radial-gradient(circle at top right, #ff45a2, transparent 40%), radial-gradient(circle at bottom left, #DA70D6, transparent 40%), radial-gradient(circle at bottom right, #5800aa, transparent 40%);
            background-size: 400% 400%;
            animation: move-bg 20s ease infinite;
        }

        .container {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: .5rem;
            background-color: #ffffff;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
            box-sizing: border-box;
        }

        .header-bg {
            background: linear-gradient(to right, #6A0DAD, #C71585);
            border-radius: 12px;
            padding: 40px 0;
            margin-bottom: 32px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .header-bg h1 {
            color: #ffffff;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .input-group {
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            color: #4a5568;
            font-size: 1rem;
            margin-bottom: 4px;
            line-height: 1.5rem;
        }

        .input-field,
        .select-field {
            border: .5px solid #cbd5e0;
            border-radius: 8px;
            padding: 9px 13px;
            font-size: 1rem;
            color: #2d3748;
            width: 100%;
            transition: all 0.2s ease-in-out;
            line-height: 1.1rem;
            border-color: var(--input-border-color, #cbd5e0);
        }

        .input-field:focus,
        .select-field:focus {
            border-color: #4B0082;
            box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.3);
            outline: none;
        }
        
        .timezone-suggestions {
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            background-color: #fff;
            z-index: 1000;
            position: absolute;
            width: inherit;
        }

        .timezone-suggestions div {
            padding: 8px;
            cursor: pointer;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }

        .timezone-suggestions div:hover {
            background-color: #e9e9e9;
        }
        
        #calculateBtn {
            background-color: #007bff;
            color: white;
            padding: 20px 40px;
            font-size: 40px;
            font-weight: bold;
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #calculateBtn:hover {
            background-color: #FF69B4;
            transform: translateY(-3px);
            box-shadow: 0 9px 25px rgba(75, 0, 130, 0.6);
        }
        #calculateBtn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .result-box {
            background-color: #e2e8f0;
            border-radius: 10px;
            padding: 18px;
            min-height: 200px;
            color: #2d3748;
            margin-top: 28px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .error-message {
            color: #ef4444;
            font-weight: 600;
            margin-top: 10px;
            font-size: 1.5rem; /* Reduced for better fit */
        }
        
        .input-error-message {
            color: #ef4444;
            font-size: 1rem;
            margin-top: 4px;
            display: none;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4B0082;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-button {
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease-in-out;
            color: #4a5568;
            background-color: #d9dcdf;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            margin-right: 2px;
            font-size: 1.2rem; /* Adjusted for better readability */
            letter-spacing: 0.05em;
        }

        .tab-button.active {
            color: #4B0082;
            background-color: #ffffff;
            border-color: #4B0082;
            border-bottom: 2px solid #ffffff;
            transform: translateY(2px);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
            z-index: 1;
        }

        .tab-button:hover:not(.active) {
            background-color: #e0efff;
        }
        
        .chart-section {
            background-color: #fefefe;
            border-radius: 12px;
            padding: 24px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.03);
            margin-bottom: 20px;
        }
        
        .synastry-inputs-wrapper {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-top: 24px;
            margin-bottom: 32px;
        }

        .synastry-input-section {
            flex: 1;
            padding: 24px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background-color: #f8fafc;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .date-time-grid,
        .location-timezone-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .location-timezone-grid .input-group.col-span-full {
            grid-column: 1 / -1;
        }
        
        .timezone-input-group-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .timezone-input-group-container .select-field,
        .timezone-input-group-container .input-field {
            flex: 1;
            min-width: 120px;
        }

        .scrollable-content {
            max-height: 300px;
            overflow-y: auto;
        }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .scrollable-content::-webkit-scrollbar-thumb:hover { background: #555; }

        .simple-section-wrapper {
            flex: 1 1 350px;
            display: flex;
            flex-direction: column;
        }
        
        .result-section-item {
            border: 1px solid #e4e6eb;
            border-radius: 6px;
            flex: 1 1 300px;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .result-section-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px;
            background-color: #f0f2f5;
            border-bottom: 1px solid #e4e6eb;
        }
        .result-section-header span {
            font-weight: 600; 
            color: #003468;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-section-content {
            flex-grow: 1;
            position: relative;
        }

        .result-section-content pre {  
            margin: 0;  
            padding: 15px;  
            white-space: pre-wrap;  
            word-wrap: break-word;  
            font-family: 'Courier New', Courier, monospace;  
            font-size: 14px;  
            line-height: 1.6;  
            color: #212529;  
            height: 100%;  
        }
        
        button.section-copy-btn, button.copy-chart-btn {
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s ease-in-out;
            background-color: #6c757d; 
            color: white;
            white-space: nowrap;
        }
        
        /* button.section-copy-btn:hover, button.copy-chart-btn:hover { opacity: 0.85; } */
        /* 為不同按鈕設定各自的 hover 效果 */
        button.section-copy-btn:hover {
            background-color: #5a6268; /* 灰色加深 */
        }

        .report-main-header .copy-report-btn:hover,
        .chart-main-header .copy-chart-btn:hover {
            filter: brightness(90%); /* 讓按鈕顏色稍微變暗，比透明度更有質感 */
        }

        .chart-main-header .copy-chart-btn {
            background-color: #42b72a; 
            color: white;
            font-size: 1rem;
            padding: 8px 16px;
        }
        
        .section-copy-btn.copied {
            background-color: #10b981;
        }
        
        .chart-type-selection-sub {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .chart-card-sub {
            background-color: #f7fafc;
            padding: 1.5rem 1rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            min-width: 160px;
            flex: 1;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .chart-card-sub:hover {
            border-color: #8B008B;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .chart-card-sub.active {
            border-color: #4B0082;
            background-color: #e6e6fa;
            box-shadow: 0 4px 15px rgba(75, 0, 130, 0.25);
        }

        .chart-card-sub h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .chart-card-sub p {
            font-size: 1rem;
            color: #6b7280;
        }
        
        .hidden {
            display: none;
        }
        
        .main-title {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            color: #1e40af;
        }

        /* --- 請將以下樣式加入到 <style> 標籤內 --- */

        /* 用於比較盤/行運盤/組合盤的總外框 */
        .report-wrapper {
            border: 1px solid #b39ddb; /* 淡紫色邊框 */
            border-radius: 12px;
            background-color: #f3e5f5; /* 非常淺的紫色背景 */
            overflow: hidden;
            margin-bottom: 1.5rem; /* 與下一個報告的間距 */
        }

        /* 報告的總標題列 */
        .report-main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            color: white;
            background: linear-gradient(to right, #6A0DAD, #C71585); /* 主要的紫色漸層 */
        }

        .report-main-header h2 {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* 讓總複製按鈕更顯眼 */
        .report-main-header .copy-report-btn {
            background-color: #4CAF50; /* 綠色 */
            font-size: 1.25rem;
            padding: 8px 16px;
            border-radius: 8px; /* 【新增】設定 8px 的圓角 */
            transition: all 0.2s ease-in-out; /* 加上過渡效果讓 hover 更平滑 */
        }
        .report-main-header .copy-report-btn:hover {
            background-color: #45a049;
        }

        /* 確保單一星盤的複製按鈕樣式也被覆蓋 */
        .chart-main-header .copy-chart-btn {
            background-color: #008CBA; /* 藍色 */
        }
        .chart-main-header .copy-chart-btn:hover {
            background-color: #007B9A;
        }

        /* --- 請用此區塊，完整取代您 style 中所有 ...-header-style 的舊規則 --- */

    /* 用於最外層的大標題，例如「您的本命盤」*/
        .single-chart-header-style {
            background: linear-gradient(135deg, #42a5f5, #1a237e); /* 淡藍 -> 稍深藍 */
            border-bottom: 1px solid #1a237e;
        }
        .single-chart-header-style h2 { /* 確保文字顏色與背景搭配 */
            color: #ffffff; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
        }

        /* 用於組合盤的大標題 */
        .composite-chart-header-style {
            background: linear-gradient(135deg, #ff9500, #fbd22d); /* 淡黃 -> 金黃 */
            border-bottom: 1px solid #fbc02d;
        }
        .composite-chart-header-style h2 {
            color: #ffffff;
            text-shadow: 1px 1px 1px #ffffff;
        }

        /* --- 以下是各個子區塊標題的專屬樣式 (全部改為漸層) --- */

        /* 用於「星盤基礎數據」標題 */
        .summary-header-style {
            background: linear-gradient(135deg, #ededed, #989898); /* 淺灰 -> 中灰 */
            border-bottom: 1px solid #bdbdbd;
        }
        .summary-header-style span {
            color: #212121; 
        }

        /* 用於「宮頭」「星體位置」「主要相位」標題 */
        .cusp-header-style, .planet-header-style, .aspect-header-style {
            background: linear-gradient(135deg, #e1f6ff, #81d4fa); /* 淺天藍 -> 天藍 */
            border-bottom: 1px solid #81d4fa;
        }
        .cusp-header-style span, .planet-header-style span, .aspect-header-style span {
            color: #01579b;
        }

        /* 用於比較盤/行運盤的互動區塊標題 */
        .interaction-header-style {
            background: linear-gradient(135deg, #4fba58, #5fb1b9); /* 薰衣草紫漸層 */
            border-bottom: 1px solid #5d39b0;
        }
        .interaction-header-style span {
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        

        .report-wrapper .chart-wrapper {
            margin: 1rem; /* 上下左右都增加 1rem 的邊距，產生內縮效果 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* 陰影可以稍微減弱 */
            border: 1px solid #d1c4e9; /* 邊框顏色也可以用主題色系的淡色 */
        }


        /* 用於「全部取消/選取」和「此類別取消/選取」的通用按鈕樣式 */
        .planet-toggle-btn {
            background-color: rgb(248, 239, 255); /* 淺灰色背景 */
            border: 1px solid indigo; /* 淺灰色邊框 */
            color: #4b5563; /* 深灰色文字 */
            padding: 2px 10px; /* 內邊距 */
            border-radius: 9999px; /* 膠囊形狀的圓角 */
            font-size: 1rem; /* 字體稍小 */
            font-weight: 600; /* 字體加粗 */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* 防止文字換行 */
        }

        .all-toggle-btn {
            padding: 3px 12px; /* 內邊距 */
        }

        /* 滑鼠移上去時的效果 */
        .planet-toggle-btn:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }

        /* 讓主標題和分類標題的容器使用 flex 排版 */
        .planet-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }


        label[for="transit_name"] {
            font-size: 1.5em; /* 字體大小 */
            color: #333;     /* 文字顏色 */
            font-weight: bold; /* 字體加粗 */
            margin-bottom: 5px; /* 下方外邊距 */
            display: block;   /* 讓它佔據一行 */
        }

        
        @media (min-width: 768px) {
            .tab-button {
                font-size: 1.5rem;
             }
             .tab-button br {
                display: none;
             }
            .sub-sections-container {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: stretch;
            }
            .date-time-grid {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }
            .location-timezone-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .input-group {
                margin-bottom: 0;
            }
            .synastry-inputs-wrapper {
                flex-direction: row;
            }
            .scrollable-content {
                max-height: 400px;
            }
        }

    </style>
</head>

<body class="bg-single">
    <div class="container">
        <div class="header-bg">
            <h1 class="text-4xl md:text-5xl font-bold text-center mb-0" style="letter-spacing: 0.1em;">星盤文字資料生成</h1>
        </div>

        <div class="tab-buttons">
            <button id="singleChartTab" class="tab-button active" data-tab-content="singleChartSection">個人星盤<br>or<br>占星卜卦</button>
            <button id="synastryTab" class="tab-button" data-tab-content="synastryChartSection">雙人合盤<br>or<br>行運盤</button>
        </div>
        
        <div id="singleChartSection" class="chart-section">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-2">姓名</h2>
            <div class="input-group">
                <input type="text" id="single_name" class="input-field" value="您">
                <p id="single_name-error" class="input-error-message" aria-live="polite"></p>
            </div>
            <br>
            <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-2">出生日期與時間</h2>
            <div class="date-time-grid">
                <div class="input-group">
                    <label for="single_year">西元年:</label>
                    <input type="number" id="single_year" class="input-field" value="1999" min="1900" max="2100">
                    <p id="single_year-error" class="input-error-message" aria-live="polite"></p>
                </div>
                <div class="input-group">
                    <label for="single_month">月:</label>
                    <input type="number" id="single_month" class="input-field" value="1" min="1" max="12">
                    <p id="single_month-error" class="input-error-message" aria-live="polite"></p>
                </div>
                <div class="input-group">
                    <label for="single_day">日:</label>
                    <input type="number" id="single_day" class="input-field" value="1" min="1" max="31">
                    <p id="single_day-error" class="input-error-message" aria-live="polite"></p>
                </div>
                <div class="input-group">
                    <label for="single_hour">時 (0-23):</label>
                    <input type="number" id="single_hour" class="input-field" value="12" min="0" max="23">
                    <p id="single_hour-error" class="input-error-message" aria-live="polite"></p>
                </div>
                <div class="input-group">
                    <label for="single_minute">分 (0-59):</label>
                    <input type="number" id="single_minute" class="input-field" value="00" min="0" max="59">
                    <p id="single_minute-error" class="input-error-message" aria-live="polite"></p>
                </div>
            </div>

            <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-2">出生地點與時區</h2>
            <div class="location-timezone-grid">
                <div class="input-group">
                    <label for="single_latitude">緯度 (+N / -S):</label>
                    <input type="number" id="single_latitude" class="input-field" value="25.00" step="0.01">
                    <p id="single_latitude-error" class="input-error-message" aria-live="polite"></p>
                </div>
                <div class="input-group">
                    <label for="single_longitude">經度 (+E / -W):</label>
                    <input type="number" id="single_longitude" class="input-field" value="121.50" step="0.01">
                    <p id="single_longitude-error" class="input-error-message" aria-live="polite"></p>
                </div>
                <div class="input-group col-span-full">
                    <label for="single_timezone">時區:</label>
                    <div class="timezone-input-group-container">
                        <select id="single_timezone" class="select-field timezone-select"></select>
                        <input type="text" id="single_customTimezone" class="input-field" placeholder="或手動輸入 IANA 時區 (例: Asia/Tokyo)">
                        <div id="singleTimezoneSuggestions" class="timezone-suggestions"></div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        * 若時區不在列表，請手動輸入出生地經緯度及「洲名/城市」格式的 IANA 時區<br>
                        （ 如台灣：Asia/Taipei，中國：Asia/Shanghai，日本：Asia/Tokyo，<br>
                        美國紐約：America/New_York，美國洛杉磯：America/Los_Angeles ）<br><br>
                        * IANA 時區可詢問AI Chat 如 Chat GPT 或 Gemini ai等，<br>
                        或由Google搜尋「[您出生城市名] IANA 時區」，以取得正確的星盤資訊。
                    </p>
                    <p id="single_timezone-error" class="input-error-message" aria-live="polite"></p>
                </div>
            </div>
        </div>

        <div id="synastryChartSection" class="chart-section hidden">
            <div class="chart-type-selection-sub" id="chartTypeSelectionSub">
                <div class="chart-card-sub active" data-chart-type="comparison">
                    <h3>比較合盤</h3>
                    <p>兩人關係互動</p>
                </div>
                <div class="chart-card-sub" data-chart-type="composite">
                    <h3>中點盤</h3>
                    <p>關係本質與命運</p>
                </div>
                <div class="chart-card-sub" data-chart-type="transit">
                    <h3>行運盤</h3>
                    <p>當下星體影響</p>
                </div>
            </div>
            <input type="hidden" id="selectedSubChartType" value="comparison">

            <div id="comparisonChartInputs" class="synastry-inputs-wrapper">
                <div class="synastry-input-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">命盤A</h3>
                    <div class="input-group"><label for="comp1_name">姓名:</label><input type="text" id="comp1_name" class="input-field" value="您"><p id="comp1_name-error" class="input-error-message" aria-live="polite"></p></div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">出生日期與時間</h4>
                    <div class="date-time-grid">
                        <div class="input-group"><label for="comp1_year">西元年:</label><input type="number" id="comp1_year" class="input-field" value="1999" min="1900" max="2100"><p id="comp1_year-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp1_month">月:</label><input type="number" id="comp1_month" class="input-field" value="1" min="1" max="12"><p id="comp1_month-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp1_day">日:</label><input type="number" id="comp1_day" class="input-field" value="1" min="1" max="31"><p id="comp1_day-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp1_hour">時:</label><input type="number" id="comp1_hour" class="input-field" value="12" min="0" max="23"><p id="comp1_hour-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp1_minute">分:</label><input type="number" id="comp1_minute" class="input-field" value="00" min="0" max="59"><p id="comp1_minute-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">出生地點與時區</h4>
                    <div class="location-timezone-grid">
                        <div class="input-group"><label for="comp1_latitude">緯度:</label><input type="number" id="comp1_latitude" class="input-field" value="25.00" step="0.01"><p id="comp1_latitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp1_longitude">經度:</label><input type="number" id="comp1_longitude" class="input-field" value="121.50" step="0.01"><p id="comp1_longitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group col-span-full"><label for="comp1_timezone">時區:</label><div class="timezone-input-group-container"><select id="comp1_timezone" class="select-field timezone-select"></select><input type="text" id="comp1_customTimezone" class="input-field" placeholder="或手動輸入 IANA 時區 "><div id="comp1TimezoneSuggestions" class="timezone-suggestions"></div></div><p id="comp1_timezone-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                        <p class="text-sm text-gray-500 mt-2">
                        * 若時區不在列表，請手動輸入出生地經緯度及「洲名/城市」格式的 IANA 時區<br>
                        （ 如台灣：Asia/Taipei，中國：Asia/Shanghai，日本：Asia/Tokyo，<br>
                        美國紐約：America/New_York，美國洛杉磯：America/Los_Angeles ）<br><br>
                        * IANA 時區可詢問AI Chat 如 Chat GPT 或 Gemini ai等，<br>
                        或由Google搜尋「[您出生城市名] IANA 時區」，以取得正確的星盤資訊。
                    </p>
                </div>
                <div class="synastry-input-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">命盤B</h3>
                    <div class="input-group"><label for="comp2_name">姓名:</label><input type="text" id="comp2_name" class="input-field" value="對方"><p id="comp2_name-error" class="input-error-message" aria-live="polite"></p></div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">出生日期與時間</h4>
                    <div class="date-time-grid">
                        <div class="input-group"><label for="comp2_year">西元年:</label><input type="number" id="comp2_year" class="input-field" value="1999" min="1900" max="2100"><p id="comp2_year-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp2_month">月:</label><input type="number" id="comp2_month" class="input-field" value="6" min="1" max="12"><p id="comp2_month-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp2_day">日:</label><input type="number" id="comp2_day" class="input-field" value="15" min="1" max="31"><p id="comp2_day-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp2_hour">時:</label><input type="number" id="comp2_hour" class="input-field" value="12" min="0" max="23"><p id="comp2_hour-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp2_minute">分:</label><input type="number" id="comp2_minute" class="input-field" value="00" min="0" max="59"><p id="comp2_minute-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">出生地點與時區</h4>
                    <div class="location-timezone-grid">
                        <div class="input-group"><label for="comp2_latitude">緯度:</label><input type="number" id="comp2_latitude" class="input-field" value="21.00" step="0.01"><p id="comp2_latitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="comp2_longitude">經度:</label><input type="number" id="comp2_longitude" class="input-field" value="121.50" step="0.01"><p id="comp2_longitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group col-span-full"><label for="comp2_timezone">時區:</label><div class="timezone-input-group-container"><select id="comp2_timezone" class="select-field timezone-select"></select><input type="text" id="comp2_customTimezone" class="input-field" placeholder="或手動輸入 IANA 時區 "><div id="comp2TimezoneSuggestions" class="timezone-suggestions"></div></div><p id="comp2_timezone-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                        <p class="text-sm text-gray-500 mt-2">
                        * 若時區不在列表，請手動輸入出生地經緯度及「洲名/城市」格式的 IANA 時區<br>
                        （ 如台灣：Asia/Taipei，中國：Asia/Shanghai，日本：Asia/Tokyo，<br>
                        美國紐約：America/New_York，美國洛杉磯：America/Los_Angeles ）<br><br>
                        * IANA 時區可詢問AI Chat 如 Chat GPT 或 Gemini ai等，<br>
                        或由Google搜尋「[您出生城市名] IANA 時區」，以取得正確的星盤資訊。
                    </p>
                </div>
            </div>

            <div id="transitChartInputs" class="synastry-inputs-wrapper hidden">
                <div class="synastry-input-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">本命盤資訊</h3>
                    <div class="input-group"><label for="natal_name">姓名:</label><input type="text" id="natal_name" class="input-field" value="您"><p id="natal_name-error" class="input-error-message" aria-live="polite"></p></div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">出生日期與時間</h4>
                    <div class="date-time-grid">
                        <div class="input-group"><label for="natal_year">西元年:</label><input type="number" id="natal_year" class="input-field" value="1999" min="1900" max="2100"><p id="natal_year-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="natal_month">月:</label><input type="number" id="natal_month" class="input-field" value="1" min="1" max="12"><p id="natal_month-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="natal_day">日:</label><input type="number" id="natal_day" class="input-field" value="1" min="1" max="31"><p id="natal_day-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="natal_hour">時:</label><input type="number" id="natal_hour" class="input-field" value="12" min="0" max="23"><p id="natal_hour-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="natal_minute">分:</label><input type="number" id="natal_minute" class="input-field" value="00" min="0" max="59"><p id="natal_minute-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">出生地點與時區</h4>
                    <div class="location-timezone-grid">
                        <div class="input-group"><label for="natal_latitude">緯度:</label><input type="number" id="natal_latitude" class="input-field" value="25.00" step="0.01"><p id="natal_latitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="natal_longitude">經度:</label><input type="number" id="natal_longitude" class="input-field" value="121.50" step="0.01"><p id="natal_longitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group col-span-full"><label for="natal_timezone">時區:</label><div class="timezone-input-group-container"><select id="natal_timezone" class="select-field timezone-select"></select><input type="text" id="natal_customTimezone" class="input-field" placeholder="或手動輸入 IANA 時區 "><div id="natalTimezoneSuggestions" class="timezone-suggestions"></div></div><p id="natal_timezone-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                        <p class="text-sm text-gray-500 mt-2">
                        * 若時區不在列表，請手動輸入出生地經緯度及「洲名/城市」格式的 IANA 時區<br>
                        （ 如台灣：Asia/Taipei，中國：Asia/Shanghai，日本：Asia/Tokyo，<br>
                        美國紐約：America/New_York，美國洛杉磯：America/Los_Angeles ）<br><br>
                        * IANA 時區可詢問AI Chat 如 Chat GPT 或 Gemini ai等，<br>
                        或由Google搜尋「[您出生城市名] IANA 時區」，以取得正確的星盤資訊。
                    </p>
                </div>
                <div class="synastry-input-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">行運盤資訊</h3>
                    <br>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 text-left">行運</h3>
                    <div class="input-group"><label for="transit_name "></label><input type="text" id="transit_name" class="input-group hidden" value="行運"><p id="transit_name-error" class="input-error-message" aria-live="polite"></p></div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">日期與時間</h4>
                    <div class="date-time-grid">
                        <div class="input-group"><label for="transit_year">西元年:</label><input type="number" id="transit_year" class="input-field" value="2025" min="1900" max="2100"><p id="transit_year-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="transit_month">月:</label><input type="number" id="transit_month" class="input-field" value="7" min="1" max="12"><p id="transit_month-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="transit_day">日:</label><input type="number" id="transit_day" class="input-field" value="1" min="1" max="31"><p id="transit_day-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="transit_hour">時:</label><input type="number" id="transit_hour" class="input-field" value="12" min="0" max="23"><p id="transit_hour-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="transit_minute">分:</label><input type="number" id="transit_minute" class="input-field" value="00" min="0" max="59"><p id="transit_minute-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">地點與時區</h4>
                    <div class="location-timezone-grid">
                        <div class="input-group"><label for="transit_latitude">緯度:</label><input type="number" id="transit_latitude" class="input-field" value="25.00" step="0.01"><p id="transit_latitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group"><label for="transit_longitude">經度:</label><input type="number" id="transit_longitude" class="input-field" value="121.50" step="0.01"><p id="transit_longitude-error" class="input-error-message" aria-live="polite"></p></div>
                        <div class="input-group col-span-full"><label for="transit_timezone">時區:</label><div class="timezone-input-group-container"><select id="transit_timezone" class="select-field timezone-select"></select><input type="text" id="transit_customTimezone" class="input-field" placeholder="或手動輸入 IANA 時區 "><div id="transitTimezoneSuggestions" class="timezone-suggestions"></div></div><p id="transit_timezone-error" class="input-error-message" aria-live="polite"></p></div>
                    </div>
                        <p class="text-sm text-gray-500 mt-2">
                        * 若時區不在列表，請手動輸入出生地經緯度及「洲名/城市」格式的 IANA 時區<br>
                        （ 如台灣：Asia/Taipei，中國：Asia/Shanghai，日本：Asia/Tokyo，<br>
                        美國紐約：America/New_York，美國洛杉磯：America/Los_Angeles ）<br><br>
                        * IANA 時區可詢問AI Chat 如 Chat GPT 或 Gemini ai等，<br>
                        或由Google搜尋「[您出生城市名] IANA 時區」，以取得正確的星盤資訊。
                    </p>
                </div>
            </div>
        </div>

        <div id="planetSelection" class="my-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl md:text-2xl font-bold text-gray-700">顯示選項 (小行星/虛點)</h3>
                <div>
                    <button id="toggleAllPlanetsBtn" class="text-sm md:text-base font-medium text-indigo-600 hover:text-indigo-800">全部取消</button>
                </div>
            </div>
            <div id="optionalPlanetsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-x-6 gap-y-3">
                </div>
        </div>

        <div class="text-center mb-6">
            <button id="calculateBtn" aria-live="polite">計算星盤</button>
            <div id="loadingSpinner" class="loading-spinner" role="status" aria-label="計算中，請稍候"></div>
        </div>

        <div class="result-section">
            <h2 class="text-2xl md:text-3xl font-semibold text-gray-700 p-4" id="resultHeader">生成結果</h2>
            <div id="resultOutput" class="result-box" role="region" aria-live="polite" aria-atomic="true"></div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Script Start Test! Version: Refactored v3.0');

        // =============================================================
        // 全域設定與常數
        // =============================================================
        const BASE_API_URL = ''; // 相對路徑，適用於前後端同源部署
        const HOUSE_DEFINING_POINTS = ['上升', '下降', '天頂', '天底'];
        const DISPLAY_ORDER_NAMES = [
            "太陽", "月亮", "水星", "金星", "火星", "木星", "土星", "天王", "海王", "冥王",
            "凱龍", "穀神", "智神", "婚神", "灶神", "愛神", "莉莉絲", "靈神", "人龍",
            "北交", "南交", "上升", "下降", "天頂", "天底", "宿命", "福點"
        ];
        const commonTimezones = [
            "Asia/Taipei", "Asia/Shanghai", "Asia/Chongqing", "Asia/Tokyo", "Asia/Hong_Kong", "Asia/Singapore",
            "America/New_York", "America/Los_Angeles", "America/Chicago", "America/Denver",
            "Europe/London", "Europe/Paris", "Europe/Berlin", "Europe/Rome",
            "Australia/Sydney", "Australia/Melbourne", "Australia/Perth"
        ];
        let allTimezones = [];

        // =============================================================
        // 工具函式
        // =============================================================
        
        // 轉換度數為度分格式
        function formatDegreesMinutesSeconds(decimalDegrees) {
            if (typeof decimalDegrees !== 'number' || isNaN(decimalDegrees)) return "N/A";
            let d = Math.floor(decimalDegrees);
            let minutesDecimal = (decimalDegrees - d) * 60;
            let m = Math.round(minutesDecimal);
            if (m >= 60) {
                d += 1;
                m = 0;
            }
            return `${String(d).padStart(2, '0')}°${String(m).padStart(2, '0')}'`;
        }

        // 顯示特定輸入框的錯誤
        function showInputError(inputId, message) {
            const inputElement = document.getElementById(inputId);
            const errorElement = document.getElementById(`${inputId}-error`);
            if (inputElement && errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                inputElement.style.setProperty('--input-border-color', '#ef4444');
            }
        }

        // 清除所有輸入框的錯誤
        function clearAllInputErrors() {
            document.querySelectorAll('.input-error-message').forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-field, .select-field').forEach(el => {
                el.style.setProperty('--input-border-color', '#cbd5e0');
            });
        }
        
        // =============================================================
        // 初始化與事件監聽器設定
        // =============================================================
        
        // 頁面啟動時執行的主要函式
        async function initializeApp() {
            setupTabListeners();
            setupSubChartListeners();
            setupPlanetCheckboxes();
            setupInputErrorClearing();
            setupCustomTimezoneListeners();
            setDefaultTransitTimeToNow();
            
            document.getElementById('calculateBtn').addEventListener('click', calculateChart);
            
            updateMainTabVisibility('singleChartTab'); // 預設顯示個人盤
            updateSubChartVisibility('comparison');   // 預設雙人盤子選項為比較盤
            
            try {
                // 不再使用全域時區列表和自動完成功能，簡化邏輯
                 populateTimezoneSelects();
                 console.log('時區下拉列表填充完成！');
            } catch (error) {
                console.error('初始化時區功能失敗:', error);
            }
        }

        // 【新增】這是一個全新的函式
        function setDefaultTransitTimeToNow() {
            const now = new Date();

            // 獲取並填入年、月、日、時、分
            document.getElementById('transit_year').value = now.getFullYear();
            document.getElementById('transit_month').value = now.getMonth() + 1; // getMonth() 是從 0 開始，所以要 +1
            document.getElementById('transit_day').value = now.getDate();
            document.getElementById('transit_hour').value = now.getHours();
            document.getElementById('transit_minute').value = now.getMinutes();
        }

        // 設定主頁籤切換
        function setupTabListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    updateMainTabVisibility(event.currentTarget.id);
                });
            });
        }

        // 設定雙人盤的子選項切換
        function setupSubChartListeners() {
            document.querySelectorAll('.chart-card-sub').forEach(card => {
                card.addEventListener('click', () => {
                    updateSubChartVisibility(card.dataset.chartType);
                });
            });
        }
        
        function setupPlanetCheckboxes() {
            const optionalPlanetsConfig = {
                '核心星體': ["太陽", "月亮", "水星", "金星", "火星", "木星", "土星", "天王", "海王", "冥王"],
                '四軸': ["上升", "下降", "天頂", "天底"],
                '命運與潛意識': ["北交", "南交", "宿命", "福點", "莉莉絲"],
                '小行星': ["凱龍", "穀神", "智神", "婚神", "灶神", "愛神", "靈神", "人龍"]
            };
            const container = document.getElementById('optionalPlanetsContainer');
            container.innerHTML = ''; // 清空

            // 【修改1】動態生成所有內容
            for (const groupName in optionalPlanetsConfig) {
                // 建立一個包含標題和按鈕的 header div
                const headerDiv = document.createElement('div');
                headerDiv.className = 'planet-group-header col-span-full mt-2'; // 使用新的 CSS class

                // 建立分類標題
                const groupTitle = document.createElement('span');
                groupTitle.className = 'font-semibold text-lg text-fuchsia-900';
                groupTitle.textContent = groupName;

                // 建立分類切換按鈕
                const groupToggleButton = document.createElement('button');
                groupToggleButton.className = 'planet-toggle-btn group-toggle-btn'; // 通用按鈕樣式 + 分類按鈕的專屬 class
                groupToggleButton.textContent = '此類別取消';
                groupToggleButton.dataset.state = 'all-checked';
                groupToggleButton.dataset.groupKey = groupName; // 用 data-* 屬性記住它屬於哪個分類

                headerDiv.appendChild(groupTitle);
                headerDiv.appendChild(groupToggleButton);
                container.appendChild(headerDiv);

                // 生成該分類下的所有 checkbox
                optionalPlanetsConfig[groupName].forEach(planet => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex items-center';
                    wrapper.innerHTML = `
                <input id="chk-${planet}" type="checkbox" value="${planet}" class="optional-planet-checkbox h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-group="${groupName}" checked>
                <label for="chk-${planet}" class="ml-2 block text-base text-gray-900">${planet}</label>
            `;
                    container.appendChild(wrapper);
                });
            }

            // 【修改2】使用「事件代理」來統一處理所有按鈕的點擊事件，更高效
            const selectionDiv = document.getElementById('planetSelection');
            selectionDiv.addEventListener('click', (event) => {
                const target = event.target;

                // --- 判斷點擊的是「總開關」按鈕 ---
                if (target.id === 'toggleAllPlanetsBtn') {
                    const checkboxes = document.querySelectorAll('.optional-planet-checkbox');
                    const isChecked = target.dataset.state === 'all-checked';
                    checkboxes.forEach(cb => { cb.checked = !isChecked; });
                    target.textContent = isChecked ? '全部選取' : '全部取消';
                    target.dataset.state = isChecked ? 'all-unchecked' : 'all-checked';

                    // 同步更新所有分類按鈕的狀態和文字
                    document.querySelectorAll('.group-toggle-btn').forEach(btn => {
                        btn.textContent = isChecked ? '此類別選取' : '此類別取消';
                        btn.dataset.state = isChecked ? 'all-unchecked' : 'all-checked';
                    });
                }

                // --- 判斷點擊的是「分類」按鈕 ---
                if (target.classList.contains('group-toggle-btn')) {
                    const groupKey = target.dataset.groupKey;
                    const checkboxesInGroup = document.querySelectorAll(`.optional-planet-checkbox[data-group="${groupKey}"]`);
                    const isChecked = target.dataset.state === 'all-checked';
                    checkboxesInGroup.forEach(cb => { cb.checked = !isChecked; });
                    target.textContent = isChecked ? '此類別選取' : '此類別取消';
                    target.dataset.state = isChecked ? 'all-unchecked' : 'all-checked';
                }
            });

            // 最後，確保最上面的總按鈕也套用新樣式
            document.getElementById('toggleAllPlanetsBtn').className = 'planet-toggle-btn all-toggle-btn';
        }

        // 設定輸入時自動清除錯誤提示
        function setupInputErrorClearing() {
             document.querySelectorAll('.input-field, .select-field').forEach(input => {
                const clearError = (event) => {
                    const errorElementId = `${event.target.id}-error`;
                    const errorElement = document.getElementById(errorElementId);
                    if (errorElement) {
                        errorElement.textContent = '';
                        errorElement.style.display = 'none';
                        event.target.style.setProperty('--input-border-color', '#cbd5e0');
                    }
                    // Special handling for timezone pairs
                    const container = event.target.closest('.timezone-input-group-container');
                    if (container) {
                        const relatedErrorId = container.querySelector('.timezone-select').id + '-error';
                        const relatedErrorElement = document.getElementById(relatedErrorId);
                        if(relatedErrorElement) {
                           relatedErrorElement.textContent = '';
                           relatedErrorElement.style.display = 'none';
                        }
                        container.querySelectorAll('.input-field, .select-field').forEach(el => el.style.setProperty('--input-border-color', '#cbd5e0'));
                    }
                };
                input.addEventListener('input', clearError);
                input.addEventListener('change', clearError);
            });
        }
        
        // 設定時區下拉選單與手動輸入的連動
        function setupCustomTimezoneListeners() {
            document.querySelectorAll('.timezone-input-group-container').forEach(container => {
                const selectEl = container.querySelector('.select-field');
                const customInputEl = container.querySelector('.input-field');
                if (selectEl && customInputEl) {
                    selectEl.addEventListener('change', () => {
                        if (selectEl.value !== '') customInputEl.value = '';
                    });
                    customInputEl.addEventListener('input', () => {
                        if (customInputEl.value.trim() !== '') selectEl.value = '';
                    });
                }
            });
        }
        
        // =============================================================
        // 核心功能函式
        // =============================================================
        
        // 更新主頁籤介面
        function updateMainTabVisibility(activeTabId) {
            const body = document.body;
            body.classList.remove('bg-single', 'bg-synastry');
            body.classList.add(activeTabId === 'singleChartTab' ? 'bg-single' : 'bg-synastry');

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(activeTabId).classList.add('active');

            document.querySelectorAll('.chart-section').forEach(sec => sec.classList.add('hidden'));
            const contentId = document.getElementById(activeTabId).dataset.tabContent;
            document.getElementById(contentId).classList.remove('hidden');
        }

        // 更新雙人盤子選項介面
        function updateSubChartVisibility(selectedType) {
            document.querySelectorAll('.chart-card-sub').forEach(card => card.classList.remove('active'));
            document.querySelector(`.chart-card-sub[data-chart-type="${selectedType}"]`).classList.add('active');
            document.getElementById('selectedSubChartType').value = selectedType;

            document.getElementById('comparisonChartInputs').classList.add('hidden');
            document.getElementById('transitChartInputs').classList.add('hidden');

            if (selectedType === 'comparison' || selectedType === 'composite') {
                document.getElementById('comparisonChartInputs').classList.remove('hidden');
            } else if (selectedType === 'transit') {
                document.getElementById('transitChartInputs').classList.remove('hidden');
            }
        }
        
        // 填充時區下拉選單
        function populateTimezoneSelects() {
             const getOffsetString = (tz) => {
                try {
                    const offset = new Intl.DateTimeFormat('en-US', { timeZone: tz, timeZoneName: 'shortOffset' }).formatToParts().find(p => p.type === 'timeZoneName').value;
                    let alias = tz.split('/').pop().replace(/_/g, ' ');
                    if (tz === "Asia/Taipei") alias = "台北";
                    if (tz === "Asia/Shanghai") alias = "上海";
                    if (tz === "Asia/Tokyo") alias = "東京";
                    return `${offset} ${alias}`;
                } catch (e) {
                    return tz;
                }
            };
            
            const sortedTimezones = commonTimezones.map(tz => ({ value: tz, text: getOffsetString(tz) }))
                                                 .sort((a, b) => a.text.localeCompare(b.text, 'en'));

            document.querySelectorAll('.timezone-select').forEach(selectElement => {
                selectElement.innerHTML = '';
                sortedTimezones.forEach(opt => {
                    const option = new Option(opt.text, opt.value);
                    selectElement.add(option);
                });
                selectElement.value = "Asia/Taipei"; // Default
            });
        }
        
        // 輸入驗證
        function validateInputs(prefix) {
            let isValid = true;
            const fields = {
                'year': { min: 1900, max: 2100, label: '年份' }, 'month': { min: 1, max: 12, label: '月份' },
                'day': { min: 1, max: 31, label: '日期' }, 'hour': { min: 0, max: 23, label: '時' },
                'minute': { min: 0, max: 59, label: '分' }, 'latitude': { min: -90, max: 90, label: '緯度' },
                'longitude': { min: -180, max: 180, label: '經度' }
            };

            for (const field in fields) {
                const inputId = `${prefix}${field}`;
                const inputElement = document.getElementById(inputId);
                const value = inputElement.value;
                const parsedValue = parseFloat(value);
                const { min, max, label } = fields[field];

                if (value.trim() === '' || isNaN(parsedValue) || parsedValue < min || parsedValue > max) {
                    showInputError(inputId, `請輸入有效的${label} (${min}-${max})。`);
                    isValid = false;
                }
            }

            const timezoneSelect = document.getElementById(`${prefix}timezone`);
            const customTimezoneInput = document.getElementById(`${prefix}customTimezone`);
            if (!timezoneSelect.value && !customTimezoneInput.value.trim()) {
                showInputError(timezoneSelect.id, '請選擇或手動輸入時區。');
                customTimezoneInput.style.setProperty('--input-border-color', '#ef4444');
                isValid = false;
            }
            return isValid;
        }

        // 主要計算函式
        async function calculateChart() {
            console.log('Calculate button clicked.');
            clearAllInputErrors();
            const resultOutput = document.getElementById('resultOutput');
            const loadingSpinner = document.getElementById('loadingSpinner');
            resultOutput.innerHTML = '';
            resultOutput.classList.remove('error-message');
            
            const getInputValue = (id) => document.getElementById(id)?.value || '';
            let payload = {};
            let apiUrl = '';
            let chart1Name = '';
            let chart2Name = '';
            let isValid = true;

            const optionalPlanets = Array.from(document.querySelectorAll('.optional-planet-checkbox:checked')).map(cb => cb.value);

            const activeMainTabId = document.querySelector('.tab-button.active').id;

            if (activeMainTabId === 'singleChartTab') {
                chart1Name = getInputValue('single_name') || "我的星盤";
                isValid = validateInputs('single_');
                if (isValid) {
                    payload = {
                        year: parseInt(getInputValue('single_year')), month: parseInt(getInputValue('single_month')), day: parseInt(getInputValue('single_day')),
                        hour: parseInt(getInputValue('single_hour')), minute: parseInt(getInputValue('single_minute')),
                        latitude: parseFloat(getInputValue('single_latitude')), longitude: parseFloat(getInputValue('single_longitude')),
                        timezone: getInputValue('single_customTimezone') || getInputValue('single_timezone'),
                        optional_planets: optionalPlanets // 將正確收集的列表放入 payload
                    };
                    apiUrl = `${BASE_API_URL}/calculate_single_chart`;
                }
            } else { // synastryChartSection
                const subChartType = document.getElementById('selectedSubChartType').value;
                if (subChartType === 'transit') {
                    chart1Name = getInputValue('natal_name') || "本命";
                    chart2Name = getInputValue('transit_name') || "行運";
                    isValid = validateInputs('natal_') && validateInputs('transit_');
                    if (isValid) {
                        payload = {
                            natal_year: parseInt(getInputValue('natal_year')), natal_month: parseInt(getInputValue('natal_month')), natal_day: parseInt(getInputValue('natal_day')),
                            natal_hour: parseInt(getInputValue('natal_hour')), natal_minute: parseInt(getInputValue('natal_minute')),
                            natal_latitude: parseFloat(getInputValue('natal_latitude')), natal_longitude: parseFloat(getInputValue('natal_longitude')),
                            natal_timezone: getInputValue('natal_customTimezone') || getInputValue('natal_timezone'),
                            transit_year: parseInt(getInputValue('transit_year')), transit_month: parseInt(getInputValue('transit_month')), transit_day: parseInt(getInputValue('transit_day')),
                            transit_hour: parseInt(getInputValue('transit_hour')), transit_minute: parseInt(getInputValue('transit_minute')),
                            transit_latitude: parseFloat(getInputValue('transit_latitude')), transit_longitude: parseFloat(getInputValue('transit_longitude')),
                            transit_timezone: getInputValue('transit_customTimezone') || getInputValue('transit_timezone'),
                            optional_planets: optionalPlanets // 將正確收集的列表放入 payload
                        };
                        apiUrl = `${BASE_API_URL}/calculate_transit_chart`;
                    }
                } else { // comparison or composite
                    chart1Name = getInputValue('comp1_name') || "您";
                    chart2Name = getInputValue('comp2_name') || "對方";
                    isValid = validateInputs('comp1_') && validateInputs('comp2_');
                    if (isValid) {
                        payload = {
                            chart1_year: parseInt(getInputValue('comp1_year')), chart1_month: parseInt(getInputValue('comp1_month')), chart1_day: parseInt(getInputValue('comp1_day')),
                            chart1_hour: parseInt(getInputValue('comp1_hour')), chart1_minute: parseInt(getInputValue('comp1_minute')),
                            chart1_latitude: parseFloat(getInputValue('comp1_latitude')), chart1_longitude: parseFloat(getInputValue('comp1_longitude')),
                            chart1_timezone: getInputValue('comp1_customTimezone') || getInputValue('comp1_timezone'),
                            chart2_year: parseInt(getInputValue('comp2_year')), chart2_month: parseInt(getInputValue('comp2_month')), chart2_day: parseInt(getInputValue('comp2_day')),
                            chart2_hour: parseInt(getInputValue('comp2_hour')), chart2_minute: parseInt(getInputValue('comp2_minute')),
                            chart2_latitude: parseFloat(getInputValue('comp2_latitude')), chart2_longitude: parseFloat(getInputValue('comp2_longitude')),
                            chart2_timezone: getInputValue('comp2_customTimezone') || getInputValue('comp2_timezone'),
                            optional_planets: optionalPlanets // 將正確收集的列表放入 payload
                        };
                        if (subChartType === 'composite') {
                            payload.composite_method = 'reference_plane'; // Hardcoded as per UI
                            apiUrl = `${BASE_API_URL}/calculate_composite_chart`;
                        } else {
                            apiUrl = `${BASE_API_URL}/calculate_comparison_chart`;
                        }
                    }
                }
            }
            
            if (!isValid) {
                resultOutput.textContent = "❌ 請更正上方標示的錯誤後再試。";
                resultOutput.classList.add('error-message');
                return;
            }

            loadingSpinner.style.display = 'inline-block';

            try {
                const response = await axios.post(apiUrl, payload);
                displayChartData(response.data, chart1Name, chart2Name);
            } catch (error) {
                resultOutput.classList.add('error-message');
                if (error.response) {
                    const errorData = error.response.data;
                    if (error.response.status === 400 && errorData?.error_type === 'invalid_timezone') {
                        resultOutput.textContent = '❌ 時區輸入錯誤，請修正上方標示的欄位。';
                        const prefix = (errorData.error_source === 'chart1') ? 'comp1_' : 'comp2_'; // Simplified assumption
                        showInputError(`${prefix}timezone`, errorData.error);
                    } else {
                        resultOutput.textContent = `❌ 伺服器錯誤 ${error.response.status}: ${errorData?.error || '未知錯誤'}`;
                    }
                } else if (error.request) {
                    resultOutput.textContent = '❌ 網路錯誤：無法連接到伺服器。';
                } else {
                    resultOutput.textContent = `❌ 請求錯誤：${error.message}`;
                }
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }
        
        // =============================================================
        // 結果顯示與 HTML 生成
        // =============================================================

        // 主顯示函式
        // 請用此版本完整取代舊的 displayChartData 函式
        function displayChartData(data, name1, name2) {
            const container = document.getElementById('resultOutput');
            container.innerHTML = '';
            let finalHtml = '';

            switch (data.chart_type) {
                case 'single':
                    finalHtml = buildSingleChartHTML(data, `${name1}的星盤資訊`);
                    break;
                case 'comparison':
                    const natal1Html = buildSingleChartHTML(data.chart1_data, `${name1}的本命盤`);
                    const natal2Html = buildSingleChartHTML(data.chart2_data, `${name2}的本命盤`);
                    const interactionHtml = `<div class="sub-sections-container">${buildOverlayHTML(data.chart1_planets_in_chart2_houses, name1, name2, `${name1}星體落入${name2}宮位`)}${buildOverlayHTML(data.chart2_planets_in_chart1_houses, name2, name1, `${name2}星體落入${name1}宮位`)}${buildInterAspectsHTML(data.inter_aspects, name1, name2)}</div>`;
                    finalHtml = createReportWrapper(`${name1}與${name2}的比較盤報告`, natal1Html + natal2Html + interactionHtml);
                    break;
                case 'composite':
                    // 【修改】為組合盤主體傳入專屬的 'composite-chart-header-style'
                    const compositeHtml = buildSingleChartHTML(data.composite_chart_data, `${name1}與${name2}的組合中點盤`, 'composite-chart-header-style');
                    // 參考盤不傳遞參數，自動使用預設的單盤樣式
                    const ref1Html = buildSingleChartHTML(data.natal_chart1_data, `${name1}的本命盤`);
                    const ref2Html = buildSingleChartHTML(data.natal_chart2_data, `${name2}的本命盤`);
                    finalHtml = createReportWrapper('組合中點盤報告', compositeHtml + ref1Html + ref2Html);
                    break;
                case 'transit':
                    const transitInteractionHtml = `<div class="sub-sections-container">${buildOverlayHTML(data.transit_planets_in_natal_houses, "行運", name1, '行運星體落入本命宮位')}${buildInterAspectsHTML(data.inter_aspects, name1, "行運", true)}</div>`;
                    const transitNatalHtml = buildSingleChartHTML(data.natal_chart_data, `${name1}的本命盤`);
                    const transitDateTime = data.transit_chart_data.timestamps.local_time;
                    // const timePart = transitDateTime.split(' ')[1].substring(0, 5); // 提取 HH:MM
                    const transitChartHtml = buildSingleChartHTML(data.transit_chart_data, `${transitDateTime} 行運天象盤`);
                    // 【修改點】將 buildInterAspectsHTML 的前兩個參數對調
                    finalHtml = createReportWrapper(`${name1}的行運盤報告`, transitInteractionHtml + transitNatalHtml + transitChartHtml);
                    break;
                default:
                    finalHtml = `<div class="error-message">錯誤: 未知的星盤類型 '${data.chart_type}'</div>`;
            }
            container.innerHTML = finalHtml;
            setupCopyListeners();
        }
        // 生成單一星盤的完整HTML
        function buildSingleChartHTML(chartInfo, title, headerStyleClass = 'single-chart-header-style') {
            if (!chartInfo) return `<div class="error-message">${title} 資料缺失。</div>`;

            const { timestamps, birth_info, house_cusps, planet_positions, aspects } = chartInfo;

            // --- 【核心修改】根據圖表類型，決定「基礎數據」的顯示內容 ---
            let summaryContent;

            // 1. 如果是組合盤，顯示其本質說明
            if (title.includes("組合中點盤")) {
                summaryContent = [
                    "==== 組合中點盤盤資訊 ====",
                    "組合中點盤為兩張本命盤的數學中點取得的星盤",
                    "===================="
                ].join('\n');
            }
            // 2. 如果是其他盤（單盤、參考盤），則顯示簡化後的基礎數據
            else {
                summaryContent = (timestamps && birth_info) ? [
                    "==== 星盤基礎數據 ====",
                    `本地時間: ${timestamps.local_time}`,
                    `UTC 時間: ${timestamps.utc_time}`,
                    `緯度: ${birth_info.latitude}, 經度: ${birth_info.longitude}`,
                    "===================="
                ].join('\n') : "基礎數據缺失";
            }

            const cuspContent = (house_cusps?.length > 0) ? [
                "==== 宮頭 ====",
                "宮頭 | 星座度數(度分)",
                "--------------------", // 加回橫線分隔線
                ...house_cusps.map(c => `${c.house_number}宮 | ${c.zodiac_position_formatted}`),
                "============"
            ].join('\n') : "宮頭數據缺失";

            const planetContent = (planet_positions) ? [
                "==== 星體位置 ====",
                "星體 | 順逆 | 星座度數(度分) | 宮位(度分)",
                "-----------------------------", // 加回橫線分隔線
                ...DISPLAY_ORDER_NAMES
                    .filter(name => planet_positions[name])
                    .map(name => {
                        const p = planet_positions[name];
                        const houseInfo = !HOUSE_DEFINING_POINTS.includes(name) && p.house != null
                            ? `${p.house}宮(${formatDegreesMinutesSeconds(p.hdeg)})` : '-';
                        return `${name} | ${p.is_retrograde ? '逆行' : ''} | ${p.zodiac_position_formatted} | ${houseInfo}`;
                    }),
                "================"
            ].join('\n') : "星體數據缺失";

            const aspectContent = (aspects?.length) > 0 ? [
                "==== 主要相位 ====",
                "星體1 | 相位 | 星體2 | 動態 | 容許度",
                "----------------------", // 加回橫線分隔線
                ...aspects.map(a => `${a.p1_name} | ${a.aspect_name} | ${a.p2_name} | ${a.aspect_type || '-'} | ${formatDegreesMinutesSeconds(a.orb)}`),
                "================"
            ].join('\n') : "沒有相位";

            return `
        <div class="chart-wrapper">
            <div class="chart-main-header ${headerStyleClass}">
                <h2 class="main-title">${title}</h2>
                <button class="copy-chart-btn">複製此盤(不含基礎數據)</button>
            </div>
            <div class="summary-section-container">
                ${createResultSection('星盤基礎數據', summaryContent, true, 'summary-header-style')}
            </div>
            <div class="sub-sections-container">
                ${createResultSection('宮頭', cuspContent, false, 'cusp-header-style')}
                ${createResultSection('星體位置', planetContent, false, 'planet-header-style')}
                ${createResultSection('主要相位', aspectContent, false, 'aspect-header-style')}
            </div>
        </div>`;
        }

        // 生成交互相位的HTML
        // 請用此版本完整取代舊的 buildInterAspectsHTML 函式
        function buildInterAspectsHTML(aspects, name1, name2, isTransit = false) {
            const title = isTransit ? `${name1}與${name2}相位` : `交互相位`;

            // 【修改】為內容加入子標題和分隔線
            const content = (aspects?.length) ? [
                `==== ${title} ====`,
                "星體1 | 相位 | 星體2 | 動態 | 容許度",
                "-----------------------------",
                ...aspects.sort((a, b) => DISPLAY_ORDER_NAMES.indexOf(a.p1_name) - DISPLAY_ORDER_NAMES.indexOf(b.p1_name) || DISPLAY_ORDER_NAMES.indexOf(a.p2_name) - DISPLAY_ORDER_NAMES.indexOf(b.p2_name)).map(a => `${a.p1_name} | ${a.aspect_name} | ${a.p2_name} | ${a.aspect_type || '-'} | ${formatDegreesMinutesSeconds(a.orb)}`),
                "===================="
            ].join('\n') : "沒有相位";

            // 這裡的 title 參數現在只用於網頁顯示，複製出來的內容自帶標題
            return createResultSection(title, content, false, 'interaction-header-style');
        }

        // 生成行星落宮的HTML
        // 請用此版本完整取代舊的 buildOverlayHTML 函式
        function buildOverlayHTML(overlayData, guestName, hostName, title) {
            // 【修改】為內容加入子標題和分隔線，並移除 padEnd()
            const content = (overlayData?.length) ? [
                `==== ${title} ====`,
                "星體 | 星座度數(度分) | 落入宮位(度分)",
                "-----------------------------",
                ...overlayData.sort((a, b) => DISPLAY_ORDER_NAMES.indexOf(a.planet_name) - DISPLAY_ORDER_NAMES.indexOf(b.planet_name))
                    .map(o => `${o.planet_name} | ${o.zodiac_position_formatted} | ${o.house_in_target_chart}宮(${formatDegreesMinutesSeconds(o.degree_in_target_house)})`),
                "===================="
            ].join('\n') : "資料缺失";

            // 這裡的 title 參數現在主要用於網頁UI顯示，複製出來的內容已自帶標題
            return createResultSection(title, content, false, 'interaction-header-style');
        }
        
        // 建立單個結果區塊的HTML (可重用)
        function createResultSection(title, content, isSummary = false, headerStyleClass = 'single-chart-header-style') {
            // 【修改說明】
            // 1. 函式簽名改變：增加了 headerStyleClass 參數，並給了它一個預設值。
            // 2. 動態加入 Class：在下方的 <div> 中，我們將 headerStyleClass 變數加入到 class 列表中。
            // 3. 複製按鈕邏輯：我們也恢復了 isSummary 參數的判斷，確保「基礎數據」區塊不會顯示複製按鈕。
            return `
        <div class="result-section-item">
            <div class="result-section-header ${headerStyleClass}">
                <span>${title}</span>
                <button class="section-copy-btn">複製</button>
            </div>
            <div class="result-section-content scrollable-content">
                <pre>${content}</pre>
            </div>
        </div>`;
        }
        
        // 設定複製按鈕的監聽器
        // 請用此版本完整取代舊的 setupCopyListeners 函式
        function setupCopyListeners() {
            document.getElementById('resultOutput').addEventListener('click', function (e) {
                const target = e.target;
                // 處理單一區塊複製
                if (target.classList.contains('section-copy-btn')) {
                    const pre = target.closest('.result-section-item').querySelector('pre');
                    if (pre) copyToClipboard(pre.textContent, target);
                }
                // 處理單一星盤複製 (不含基礎數據)
                else if (target.classList.contains('copy-chart-btn')) {
                    const chartWrapper = target.closest('.chart-wrapper');
                    const title = chartWrapper.querySelector('.chart-main-header h2').textContent;
                    let textToCopy = `${title}\n====================\n\n`;
                    chartWrapper.querySelectorAll('.sub-sections-container .result-section-item').forEach(block => {
                        textToCopy += `${block.querySelector('.result-section-header span').textContent}\n${"-".repeat(20)}\n${block.querySelector('pre').textContent}\n\n`;
                    });
                    copyToClipboard(textToCopy.trim(), target);
                }
                // 處理報告總複製
                else if (target.classList.contains('copy-report-btn')) {
                    const reportWrapper = target.closest('.report-wrapper');
                    let fullText = `${reportWrapper.querySelector('.report-main-header h2').textContent}\n====================\n\n`;
                    // 遍歷報告內所有的內容區塊
                    reportWrapper.querySelectorAll('.chart-wrapper, .sub-sections-container > .result-section-item').forEach(section => {
                        if (section.classList.contains('chart-wrapper')) {
                            // 如果是單一星盤，複製其標題和非隱私內容
                            fullText += `--- ${section.querySelector('.chart-main-header h2').textContent} ---\n`;
                            section.querySelectorAll('.sub-sections-container .result-section-item').forEach(block => {
                                fullText += `${block.querySelector('.result-section-header span').textContent}\n${"-".repeat(20)}\n${block.querySelector('pre').textContent}\n\n`;
                            });
                        } else if (section.closest('.sub-sections-container')) {
                            // 如果是互動區塊
                            fullText += `--- ${section.querySelector('.result-section-header span').textContent} ---\n${section.querySelector('pre').textContent}\n\n`;
                        }
                    });
                    copyToClipboard(fullText.trim(), target);
                }
            });
        }

        // 這是一個全新的函式，請將它新增到 script 中
        function createReportWrapper(title, content) {
            return `<div class="report-wrapper">
                <div class="report-main-header">
                    <h2>${title}</h2>
                    <button class="copy-report-btn">複製完整報告</button>
                </div>
                ${content}
            </div>`;
        }

        // 複製到剪貼簿的輔助函式
        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = '已複製!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('複製失敗:', err);
                btn.textContent = '失敗';
            });
        }
        
        // 執行初始化
        initializeApp();
    });
</script>

</body>
</html>